# ------------DO-NOT-MODIFY-THIS-FILE------------
# This file was automatically generated by github-actions-workflow-ts.
# Instead, modify workflows/release-hotfix.wac.ts
# ------------DO-NOT-MODIFY-THIS-FILE------------

'on':
  workflow_dispatch: {}
jobs:
  typos:
    runs-on: ubuntu-latest
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: crate-ci/typos@v1.39.0
    name: ðŸ…² typos
  ci-checks:
    secrets: inherit
    uses: elastio/ci-lib/.github/workflows/ci-checks.yml@v0.0.9
    name: ðŸ…² ci checks
  check-golang-fmt:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - run: gofmt -w .
      - run: |-
          git diff --exit-code --color=always             || (echo -e "

          Run gofmt and commit the changes" && exit 1)
    name: ðŸ…² check golang fmt
  check-golang-lint:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: golangci/golangci-lint-action@v8
    name: ðŸ…² check golang lint
  check-build:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-go-build-${{ hashFiles('go.mod') }}
          path: /go/pkg/mod
      - name: Build
        run: |-
          go mod download
          go build ./...
    name: ðŸ…² check build
  wait-all-checks:
    needs:
      - typos
      - ci-checks
      - check-golang-fmt
      - check-golang-lint
      - check-build
    runs-on: bluestack
    container:
      image: elastio/infra_shell:sha-ca88e5d
      options: '--user elastio'
    if: ${{ always() }}
    steps:
      - name: Check all dependent jobs
        run: |-
          #!/bin/bash

          # Set error handling
          set -euo pipefail

          json_file="needs.json"

          # Store dependent job results
          cat <<EOF > "$json_file"
          ${{ toJson(needs) }}
          EOF

          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          GRAY='\033[0;90m'
          NC='\033[0m' # No Color
          BOLD='\033[1m'

          # Function to print status with color
          print_status() {
            local status=$1
            case $status in
              "success")
                echo -e "${GREEN}âœ“ SUCCESS${NC}"
                ;;
              "failure")
                echo -e "${RED}âœ— FAILURE${NC}"
                ;;
              "cancelled")
                echo -e "${YELLOW}âŠ˜ CANCELLED${NC}"
                ;;
              "skipped")
                echo -e "${GRAY}â—‹ SKIPPED${NC}"
                ;;
              *)
                echo -e "${YELLOW}? UNKNOWN: ${status}${NC}"
                ;;
            esac
          }

          # Check if file exists
          if [ ! -f "$json_file" ]; then
            echo "Error: File $json_file does not exist"
            exit 1
          fi

          # Get counts for different statuses
          total_jobs=$(jq -r 'length' "$json_file")
          failed_jobs=$(jq -r 'to_entries | map(select(.value.result == "failure")) | length' "$json_file")
          cancelled_jobs=$(jq -r 'to_entries | map(select(.value.result == "cancelled")) | length' "$json_file")
          skipped_jobs=$(jq -r 'to_entries | map(select(.value.result == "skipped")) | length' "$json_file")
          successful_jobs=$(jq -r 'to_entries | map(select(.value.result == "success")) | length' "$json_file")

          # Print job results
          jq -r 'to_entries | .[] | "\(.key) \(.value.result)"' "$json_file" | while read -r job result; do
            printf "%-20s" "$job"  # Pad job name to 20 characters for alignment
            print_status "$result"
          done

          echo
          echo -e "${BOLD}Summary:${NC}"
          echo -e "Total jobs: $total_jobs"
          echo -e "  ${GREEN}Successful: $successful_jobs${NC}"
          [ $skipped_jobs -gt 0 ] && echo -e "  ${GRAY}Skipped: $skipped_jobs${NC}"
          [ $cancelled_jobs -gt 0 ] && echo -e "  ${YELLOW}Cancelled: $cancelled_jobs${NC}"
          [ $failed_jobs -gt 0 ] && echo -e "  ${RED}Failed: $failed_jobs${NC}"

          # Determine exit status
          if [ "$failed_jobs" -gt 0 ] || [ "$cancelled_jobs" -gt 0 ]; then
            echo
            if [ "$failed_jobs" -gt 0 ] && [ "$cancelled_jobs" -gt 0 ]; then
              echo -e "${RED}${BOLD}Pipeline failed: Found $failed_jobs failed and $cancelled_jobs cancelled jobs!${NC}"
            elif [ "$failed_jobs" -gt 0 ]; then
              echo -e "${RED}${BOLD}Pipeline failed: Found $failed_jobs failed jobs!${NC}"
            else
              echo -e "${YELLOW}${BOLD}Pipeline cancelled: Found $cancelled_jobs cancelled jobs!${NC}"
            fi
            exit 1
          fi
  build-image:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs:
      - wait-all-checks
    name: Build shared-services image
    runs-on: bluestack
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RW
          region: us-east-2
          role_duration_seconds: 3600
      - id: login-ecr
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.BS_RESOURCES_AWS_ACCOUNT_ID }}
          mask-password: 'true'
          skip-logout: 'true'
      - name: Configure environment
        run: |-
          set -eu

          declare -A env_map=(
            ["refs/heads/master"]="development master"
            ["refs/heads/staging"]="staging staging"
            ["refs/heads/production"]="production production"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment cell_env_name <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT=${environment}" >> $GITHUB_ENV
          echo "CELL_ENV_NAME=${cell_env_name}" >> $GITHUB_ENV
      - name: Configure registry environment
        run: |-
          set -eu
          echo "REPOSITORY=${ENVIRONMENT}/blues/shared-services/service" >> "$GITHUB_ENV"
          echo "REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> "$GITHUB_ENV"
      - uses: docker/build-push-action@v6
        with:
          pull: true
          push: true
          tags: |-
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:latest
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:${{ github.sha }}
          labels: |-
            github.sha=${{ github.sha }}
            github.ref=${{ github.ref }}
          secrets: DEPS_TOKEN=${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}
          build-args: VERSION=${{ github.sha }}
  deploy-to-k8s:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs:
      - build-image
    name: Deploy shared-services to Kubernetes
    runs-on: bluestack
    container:
      image: elastio/infra_shell:sha-ca88e5d
      options: '--user elastio'
    env:
      HOME: /home/elastio
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Add Helm repo
        run: helm repo add elastio-private 'https://dl.cloudsmith.io/basic/elastio/private/helm/charts/' --username '${{ secrets.CLOUDSMITH_HELM_REPO_USERNAME }}' --password '${{ secrets.CLOUDSMITH_HELM_REPO_PASSWORD }}' || true
      - name: Configure environment
        run: |-
          set -eu

          declare -A env_map=(
            ["refs/heads/master"]="development master"
            ["refs/heads/staging"]="staging staging"
            ["refs/heads/production"]="production production"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment cell_env_name <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT=${environment}" >> $GITHUB_ENV
          echo "CELL_ENV_NAME=${cell_env_name}" >> $GITHUB_ENV
      - run: |-
          set -euo pipefail

          case "${{ github.ref }}" in
            "refs/heads/master")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_STAGING_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            "refs/heads/staging")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_STAGING_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            "refs/heads/production")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_PRODUCTION_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_PRODUCTION_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown environment, exiting."
              exit 1
              ;;
          esac
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: ${{ env.AWS_ROLE_ARN }}
          region: ${{ env.AWS_REGION }}
          role_duration_seconds: 3600
      - run: helm dep build ./.helm
      - name: Get cell configuration
        run: |-
          CFG=$(jq ".\"${CELL_ENV_NAME}\"" < ci/deployment/bs-cells.json)

          echo "CELL_REGION=$(echo $CFG | jq -r '.region')" >> $GITHUB_ENV
          echo "CELL_ENV_TYPE=$(echo $CFG | jq -r '.env_type')" >> $GITHUB_ENV
          echo "CELL_NAME=$(echo $CFG | jq -r '.name')" >> $GITHUB_ENV
          echo "CELL_ACCOUNT_ID=$(echo $CFG | jq -r '.aws_account_id')" >> $GITHUB_ENV
          echo "CELL_HOSTED_ZONE_NAME=$(echo $CFG | jq -r '.cell_hosted_zone_name')" >> $GITHUB_ENV
          echo "CELL_DNS_NAME=$(echo $CFG | jq -r '.dns_name')" >> $GITHUB_ENV
      - name: Update kube configuration
        run: aws eks update-kubeconfig --name $CELL_ENV_TYPE-$CELL_NAME
      - name: Deploy to Kubernetes
        run: helm secrets upgrade             --install             --namespace blues             --wait shared-services             --timeout 600s             --set "global.awsRegion=$CELL_REGION"             --set "global.mskClusterName=kafka-msk-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME"             --set "global.environment=$CELL_ENV_TYPE"             --set "global.commit=${{ github.sha }}"             --set "global.branch=${{ github.ref_name }}"             --set "global.buildID=${{ github.run_id }}"             --set "global.cellDnsName=$CELL_ACCOUNT_ID-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME.$CELL_HOSTED_ZONE_NAME"             --set "global.dnsName=$CELL_DNS_NAME"             -f ./.helm/secrets.$CELL_ENV_TYPE.yaml             -f ./.helm/values.$CELL_ENV_TYPE.yaml             ./.helm
      - name: Patch Deployment with ServiceAccount
        run: kubectl patch deployment shared-services -n blues             --type='strategic'             -p '{"spec":{"template":{"spec":{"serviceAccountName":"shared-services-service-account"}}}}'
concurrency:
  group: ${{ ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) && 'release' || github.ref }}
  cancel-in-progress: ${{ ! ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) }}
env:
  TSAR_FERRIS_GITHUB_TOKEN: ${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}
  PRIVATE_REGISTRY_TOKEN: ${{ secrets.PRIVATE_REGISTRY_TOKEN }}
  CI_CACHE_PASSWORD: ${{ secrets.CI_CACHE_PASSWORD }}
  CI_CACHE_USER: ${{ secrets.CI_CACHE_USER }}
  RUSTFLAGS: '--deny warnings -Cdebuginfo=0'
  RUSTDOCFLAGS: '--deny warnings'
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 50
  CARGO_TERM_COLOR: always
  CARGO_REGISTRIES_ELASTIO_PRIVATE_TOKEN: ${{ secrets.CLOUDSMITH_API_TOKEN }}
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  TF_IN_AUTOMATION: 1
  ELASTIO_DISABLE_SENTRY: 'true'
  NPM_PRIVATE_REGISTRY: npm.cloudsmith.io/elastio/private/
  CI_BS_RESOURCES_AWS_DEFAULT_REGION: us-east-2
  CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION: eu-central-1
  CI_BLUE_STACK_PRODUCTION_AWS_DEFAULT_REGION: us-east-2
name: release-hotfix
defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}
permissions:
  contents: read
  id-token: write
