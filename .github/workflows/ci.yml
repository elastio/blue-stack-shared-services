# ------------DO-NOT-MODIFY-THIS-FILE------------
# This file was automatically generated by github-actions-workflow-ts.
# Instead, modify workflows/ci.wac.ts
# ------------DO-NOT-MODIFY-THIS-FILE------------

name: ci
'on':
  pull_request:
    branches:
      - master
      - staging
      - production
  push:
    branches:
      - master
  workflow_dispatch: {}
jobs:
  typos:
    runs-on: ubuntu-latest
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: crate-ci/typos@v1.39.0
    name: ðŸ…² typos
  ci-checks:
    secrets: inherit
    uses: elastio/ci-lib/.github/workflows/ci-checks.yml@v0.0.9
    name: ðŸ…² ci checks
  check-golang-fmt:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - run: gofmt -w .
      - run: |-
          git diff --exit-code --color=always             || (echo -e "

          Run gofmt and commit the changes" && exit 1)
    name: ðŸ…² check golang fmt
  check-golang-lint:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: golangci/golangci-lint-action@v8
    name: ðŸ…² check golang lint
  check-build:
    runs-on: bluestack
    container:
      image: elastio/golang_ci:sha-2dee071
      options: '--user elastio'
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-go-build-${{ hashFiles('go.mod') }}
          path: /go/pkg/mod
      - name: Build
        run: |-
          go mod download
          go build ./...
    name: ðŸ…² check build
  check-image-version:
    if: github.base_ref == 'master' || github.ref == 'refs/heads/master'
    runs-on: bluestack
    permissions:
      contents: read
      pull-requests: read
      id-token: write
    outputs:
      has_source_changes: ${{ steps.changed.outputs.verdict }}
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Read semantic version
        uses: mikefarah/yq@v4.48.1
        with:
          cmd: echo VERSION=$(yq '.release' .semver.yaml) >> $GITHUB_ENV
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RO
          region: us-east-2
          role_duration_seconds: 3600
      - name: Check source changes
        uses: dorny/paths-filter@v3
        id: changed
        with:
          filters: 'verdict: [config/**, internal/**, logger/**, scripts/**, main.go, go.mod, go.sum, .semver.yaml, Dockerfile]'
      - name: Check whether image version already exists
        if: steps.changed.outputs.verdict == 'true'
        run: if             aws ecr describe-images               --repository-name development/blues/shared-services/service               --image-ids imageTag=${{ env.VERSION }}               --region us-east-2;           then             echo "Image with tag ${{ env.VERSION }} already exists. Please update version in .semver.yaml.";             exit 1;           fi
    name: ðŸ…² check image version
  build-image:
    name: Build shared-services image
    if: needs.check-image-version.outputs.has_source_changes != 'false'
    needs:
      - typos
      - ci-checks
      - check-golang-fmt
      - check-golang-lint
      - check-build
      - check-image-version
    runs-on: bluestack
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production') && 'arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RW' || 'arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RO' }}
          region: us-east-2
          role_duration_seconds: 3600
      - id: login-ecr
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: true
          skip-logout: true
          registry-type: private
      - name: Read semantic version
        uses: mikefarah/yq@v4.48.1
        with:
          cmd: echo VERSION=$(yq '.release' .semver.yaml) >> $GITHUB_ENV
      - uses: docker/build-push-action@v6
        with:
          pull: true
          push: ${{ github.ref == 'refs/heads/master' }}
          tags: |-
            ${{ steps.login-ecr.outputs.registry }}/development/blues/shared-services/service:latest
            ${{ steps.login-ecr.outputs.registry }}/development/blues/shared-services/service:${{ env.VERSION }}
            ${{ steps.login-ecr.outputs.registry }}/development/blues/shared-services/service:${{ github.sha }}
          labels: |-
            org.opencontainers.image.version=${{ env.VERSION }}
            org.opencontainers.image.ref.name=${{ github.ref_name }}
            org.opencontainers.image.ref.sha=${{ github.sha }}
          secrets: DEPS_TOKEN=${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}
          build-args: VERSION=${{ github.sha }}
  generate-sbom:
    name: Generate SBOM
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs:
      - typos
      - ci-checks
      - check-golang-fmt
      - check-golang-lint
      - check-build
      - check-image-version
    runs-on: bluestack
    steps:
      - uses: elastio/actions/checkout@v1
      - uses: elastio/actions/install@v1
        with:
          tool: trivy
      - name: Generate SBOM
        run: trivy repo go.mod --format cyclonedx --output result.cdx.json
      - uses: DependencyTrack/gh-upload-sbom@v3
        with:
          serverHostname: deps-track.elastio.dev
          apiKey: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}
          autoCreate: 'true'
          bomFilename: result.cdx.json
          projectName: blue-stack-shared-services
          projectVersion: ${{ github.ref_name }}
          projectTags: blue-stack,golang
  deploy-to-k8s:
    name: Deploy to Kubernetes
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs:
      - build-image
    container:
      image: elastio/infra_shell:sha-ca88e5d
      options: '--user elastio'
    runs-on: bluestack
    env:
      HOME: /home/elastio
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Add Helm repo
        run: helm repo add elastio-private 'https://dl.cloudsmith.io/basic/elastio/private/helm/charts/' --username '${{ secrets.CLOUDSMITH_HELM_REPO_USERNAME }}' --password '${{ secrets.CLOUDSMITH_HELM_REPO_PASSWORD }}' || true
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: arn:aws:iam::937593779230:role/Github-Actions-OIDC-Role
          region: eu-central-1
          role_duration_seconds: 3600
      - run: helm dep build ./.helm
      - name: Get cell configuration
        run: |-
          CFG=$(jq '."master"' < ci/deployment/bs-cells.json)

          echo "CELL_REGION=$(echo $CFG | jq -r '.region')" >> $GITHUB_ENV
          echo "CELL_ENV_TYPE=$(echo $CFG | jq -r '.env_type')" >> $GITHUB_ENV
          echo "CELL_NAME=$(echo $CFG | jq -r '.name')" >> $GITHUB_ENV
          echo "CELL_ACCOUNT_ID=$(echo $CFG | jq -r '.aws_account_id')" >> $GITHUB_ENV
          echo "CELL_HOSTED_ZONE_NAME=$(echo $CFG | jq -r '.cell_hosted_zone_name')" >> $GITHUB_ENV
          echo "CELL_DNS_NAME=$(echo $CFG | jq -r '.dns_name')" >> $GITHUB_ENV
      - name: Update kube configuration
        run: aws eks update-kubeconfig --name $CELL_ENV_TYPE-$CELL_NAME
      - name: Deploy to Kubernetes
        run: helm secrets upgrade             --install             --namespace blues             --wait shared-services             --timeout 600s             --set "global.awsRegion=$CELL_REGION"             --set "global.mskClusterName=kafka-msk-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME"             --set "global.environment=$CELL_ENV_TYPE"             --set "global.commit=${{ github.sha }}"             --set "global.branch=${{ github.ref_name }}"             --set "global.buildID=${{ github.run_id }}"             --set "global.cellDnsName=$CELL_ACCOUNT_ID-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME.$CELL_HOSTED_ZONE_NAME"             --set "global.dnsName=$CELL_DNS_NAME"             -f ./.helm/secrets.$CELL_ENV_TYPE.yaml             -f ./.helm/values.$CELL_ENV_TYPE.yaml             ./.helm
      - name: Patch Deployment with ServiceAccount
        run: kubectl patch deployment shared-services -n blues             --type='strategic'             -p '{"spec":{"template":{"spec":{"serviceAccountName":"shared-services-service-account"}}}}'
concurrency:
  group: ${{ ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) && 'release' || github.ref }}
  cancel-in-progress: ${{ ! ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) }}
defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}
env:
  TSAR_FERRIS_GITHUB_TOKEN: ${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}
  PRIVATE_REGISTRY_TOKEN: ${{ secrets.PRIVATE_REGISTRY_TOKEN }}
  CI_CACHE_PASSWORD: ${{ secrets.CI_CACHE_PASSWORD }}
  CI_CACHE_USER: ${{ secrets.CI_CACHE_USER }}
  RUSTFLAGS: '--deny warnings -Cdebuginfo=0'
  RUSTDOCFLAGS: '--deny warnings'
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 50
  CARGO_TERM_COLOR: always
  CARGO_REGISTRIES_ELASTIO_PRIVATE_TOKEN: ${{ secrets.CLOUDSMITH_API_TOKEN }}
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  TF_IN_AUTOMATION: 1
  ELASTIO_DISABLE_SENTRY: 'true'
  NPM_PRIVATE_REGISTRY: npm.cloudsmith.io/elastio/private/
permissions:
  contents: read
  id-token: write
