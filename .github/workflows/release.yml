# ------------DO-NOT-MODIFY-THIS-FILE------------
# This file was automatically generated by github-actions-workflow-ts.
# Instead, modify workflows/release.wac.ts
# ------------DO-NOT-MODIFY-THIS-FILE------------

'on':
  workflow_dispatch: {}
jobs:
  configure-promotion:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    runs-on: bluestack
    outputs:
      environment: ${{ steps.get-output.outputs.environment }}
      environment_to_promote: ${{ steps.get-output.outputs.environment_to_promote }}
      branch_to_promote: ${{ steps.get-output.outputs.branch_to_promote }}
      commit_to_promote: ${{ steps.get-commit-to-promote.outputs.commit_sha }}
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Unshallow the repository
        run: git fetch --unshallow || git fetch --all
      - name: Configure environment
        run: |-
          set -eu

          declare -A env_map=(
            ["refs/heads/master"]="development master"
            ["refs/heads/staging"]="staging staging"
            ["refs/heads/production"]="production production"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment cell_env_name <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT=${environment}" >> $GITHUB_ENV
          echo "CELL_ENV_NAME=${cell_env_name}" >> $GITHUB_ENV
      - name: Configure promotion environment
        run: |-
          set -euxo pipefail

          declare -A env_map=(
            ["refs/heads/staging"]="development master"
            ["refs/heads/production"]="staging staging"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment branch <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT_TO_PROMOTE=${environment}" >> $GITHUB_ENV
          echo "BRANCH_TO_PROMOTE=${branch}" >> $GITHUB_ENV
      - id: get-output
        name: Configure environment output
        run: |-
          set -euo pipefail

          echo "environment=${ENVIRONMENT}" >> ${GITHUB_OUTPUT}
          echo "environment_to_promote=${ENVIRONMENT_TO_PROMOTE}" >> ${GITHUB_OUTPUT}
          echo "branch_to_promote=${BRANCH_TO_PROMOTE}" >> ${GITHUB_OUTPUT}
      - id: get-commit-to-promote
        name: Get the commit to promote
        run: |-
          set -euo pipefail

          echo "Promotion from branch: $ENVIRONMENT_TO_PROMOTE"
          echo "Promotion to branch: $ENVIRONMENT"
          echo "Current commit: ${{ github.sha }}"

          found_commit=""
          while read commit; do
            if git branch --remote --contains "$commit" | grep -q "origin/$BRANCH_TO_PROMOTE$"; then
              echo "Selected commit $commit"
              echo "commit_sha=${commit}" >> ${GITHUB_OUTPUT}
              found_commit="$commit"
              break
            fi
            echo "Skipping commit $commit"
          done < <(git rev-list -n 300 HEAD)

          if [[ -z "$found_commit" ]]; then
            echo "Commit to promote not found" >&2
            exit 1
          fi
  promote-image:
    name: Promote shared-services image
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    runs-on: bluestack
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Install crane
        uses: elastio/actions/install@v1
        with:
          tool: crane
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RW
          region: us-east-2
          role_duration_seconds: 3600
      - id: login-ecr
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.BS_RESOURCES_AWS_ACCOUNT_ID }}
          mask-password: 'true'
          skip-logout: 'true'
      - name: Configure environment
        run: |-
          set -eu

          declare -A env_map=(
            ["refs/heads/master"]="development master"
            ["refs/heads/staging"]="staging staging"
            ["refs/heads/production"]="production production"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment cell_env_name <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT=${environment}" >> $GITHUB_ENV
          echo "CELL_ENV_NAME=${cell_env_name}" >> $GITHUB_ENV
      - name: Configure registry environment
        run: |-
          set -eu
          echo "REPOSITORY=${ENVIRONMENT}/blues/shared-services/service" >> "$GITHUB_ENV"
          echo "REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> "$GITHUB_ENV"
      - name: Configure promotion environment
        run: |-
          set -euxo pipefail

          declare -A env_map=(
            ["refs/heads/staging"]="development master"
            ["refs/heads/production"]="staging staging"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment branch <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT_TO_PROMOTE=${environment}" >> $GITHUB_ENV
          echo "BRANCH_TO_PROMOTE=${branch}" >> $GITHUB_ENV
      - name: Promote image
        run: |-
          set -eu

          IMAGE_TAG_TO_PROMOTE="${{ needs.configure-promotion.outputs.commit_to_promote }}"
          IMAGE_TAG="${{ github.sha }}"

          echo "Moving image from $ENVIRONMENT_TO_PROMOTE to $ENVIRONMENT"
          echo "Source tag: $IMAGE_TAG_TO_PROMOTE"
          echo "Destination tag: $IMAGE_TAG"

          IMAGE_PATH=$REGISTRY/$REPOSITORY

          IMAGE_URL=$IMAGE_PATH:$IMAGE_TAG
          IMAGE_URL_TO_PROMOTE=${IMAGE_PATH/$ENVIRONMENT/$ENVIRONMENT_TO_PROMOTE}:$IMAGE_TAG_TO_PROMOTE

          crane cp "${IMAGE_URL_TO_PROMOTE}" "${IMAGE_URL}"
    needs:
      - configure-promotion
  deploy-to-k8s:
    name: Deploy shared-services to Kubernetes
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    runs-on: bluestack
    container:
      image: elastio/infra_shell:sha-ca88e5d
      options: '--user elastio'
    env:
      HOME: /home/elastio
    steps:
      - uses: elastio/actions/checkout@v1
      - name: Add Helm repo
        run: helm repo add elastio-private 'https://dl.cloudsmith.io/basic/elastio/private/helm/charts/' --username '${{ secrets.CLOUDSMITH_HELM_REPO_USERNAME }}' --password '${{ secrets.CLOUDSMITH_HELM_REPO_PASSWORD }}' || true
      - name: Configure environment
        run: |-
          set -eu

          declare -A env_map=(
            ["refs/heads/master"]="development master"
            ["refs/heads/staging"]="staging staging"
            ["refs/heads/production"]="production production"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment cell_env_name <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT=${environment}" >> $GITHUB_ENV
          echo "CELL_ENV_NAME=${cell_env_name}" >> $GITHUB_ENV
      - run: |-
          set -euo pipefail

          case "${{ github.ref }}" in
            "refs/heads/master")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_STAGING_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            "refs/heads/staging")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_STAGING_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            "refs/heads/production")
              echo "AWS_ROLE_ARN=${{ secrets.CI_BLUE_STACK_PRODUCTION_AWS_ROLE_ARN }}" >> $GITHUB_ENV
              echo "AWS_REGION=${{ env.CI_BLUE_STACK_PRODUCTION_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown environment, exiting."
              exit 1
              ;;
          esac
      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: ${{ env.AWS_ROLE_ARN }}
          region: ${{ env.AWS_REGION }}
          role_duration_seconds: 3600
      - run: helm dep build ./.helm
      - name: Get cell configuration
        run: |-
          CFG=$(jq ".\"${CELL_ENV_NAME}\"" < ci/deployment/bs-cells.json)

          echo "CELL_REGION=$(echo $CFG | jq -r '.region')" >> $GITHUB_ENV
          echo "CELL_ENV_TYPE=$(echo $CFG | jq -r '.env_type')" >> $GITHUB_ENV
          echo "CELL_NAME=$(echo $CFG | jq -r '.name')" >> $GITHUB_ENV
          echo "CELL_ACCOUNT_ID=$(echo $CFG | jq -r '.aws_account_id')" >> $GITHUB_ENV
          echo "CELL_HOSTED_ZONE_NAME=$(echo $CFG | jq -r '.cell_hosted_zone_name')" >> $GITHUB_ENV
          echo "CELL_DNS_NAME=$(echo $CFG | jq -r '.dns_name')" >> $GITHUB_ENV
      - name: Update kube configuration
        run: aws eks update-kubeconfig --name $CELL_ENV_TYPE-$CELL_NAME
      - name: Deploy to Kubernetes
        run: helm secrets upgrade             --install             --namespace blues             --wait shared-services             --timeout 600s             --set "global.awsRegion=$CELL_REGION"             --set "global.mskClusterName=kafka-msk-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME"             --set "global.environment=$CELL_ENV_TYPE"             --set "global.commit=${{ github.sha }}"             --set "global.branch=${{ github.ref_name }}"             --set "global.buildID=${{ github.run_id }}"             --set "global.cellDnsName=$CELL_ACCOUNT_ID-$CELL_REGION-$CELL_ENV_TYPE-$CELL_NAME.$CELL_HOSTED_ZONE_NAME"             --set "global.dnsName=$CELL_DNS_NAME"             -f ./.helm/secrets.$CELL_ENV_TYPE.yaml             -f ./.helm/values.$CELL_ENV_TYPE.yaml             ./.helm
      - name: Patch Deployment with ServiceAccount
        run: kubectl patch deployment shared-services -n blues             --type='strategic'             -p '{"spec":{"template":{"spec":{"serviceAccountName":"shared-services-service-account"}}}}'
    needs:
      - promote-image
concurrency:
  group: ${{ ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) && 'release' || github.ref }}
  cancel-in-progress: ${{ ! ( github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production' ) }}
env:
  TSAR_FERRIS_GITHUB_TOKEN: ${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}
  PRIVATE_REGISTRY_TOKEN: ${{ secrets.PRIVATE_REGISTRY_TOKEN }}
  CI_CACHE_PASSWORD: ${{ secrets.CI_CACHE_PASSWORD }}
  CI_CACHE_USER: ${{ secrets.CI_CACHE_USER }}
  RUSTFLAGS: '--deny warnings -Cdebuginfo=0'
  RUSTDOCFLAGS: '--deny warnings'
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 50
  CARGO_TERM_COLOR: always
  CARGO_REGISTRIES_ELASTIO_PRIVATE_TOKEN: ${{ secrets.CLOUDSMITH_API_TOKEN }}
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  TF_IN_AUTOMATION: 1
  ELASTIO_DISABLE_SENTRY: 'true'
  NPM_PRIVATE_REGISTRY: npm.cloudsmith.io/elastio/private/
  CI_BS_RESOURCES_AWS_DEFAULT_REGION: us-east-2
  CI_BLUE_STACK_STAGING_AWS_DEFAULT_REGION: eu-central-1
  CI_BLUE_STACK_PRODUCTION_AWS_DEFAULT_REGION: us-east-2
name: release
defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}
permissions:
  contents: read
  id-token: write
