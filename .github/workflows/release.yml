name: release

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  TSAR_FERRIS_GITHUB_TOKEN: ${{ secrets.TSAR_FERRIS_GITHUB_TOKEN }}

defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

concurrency:
  group: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production') && 'release' || github.ref }}
  cancel-in-progress: ${{ !(github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production') }}

jobs:
  configure-promotion:
    name: Configure promotion
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    runs-on: bluestack
    outputs:
      environment: ${{ steps.get-output.outputs.environment }}
      environment_to_promote: ${{ steps.get-output.outputs.environment_to_promote }}
      branch_to_promote: ${{ steps.get-output.outputs.branch_to_promote }}
      commit_to_promote: ${{ steps.get-commit-to-promote.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Unshallow the repository
        run: git fetch --unshallow || git fetch --all

      - name: Configure environment
        uses: elastio/gh-actions/actions/configure-env@master

      - name: Configure promotion environment
        run: |
          set -euxo pipefail

          declare -A env_map=(
            ["refs/heads/staging"]="development master"
            ["refs/heads/production"]="staging staging"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment branch <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT_TO_PROMOTE=${environment}" >> "$GITHUB_ENV"
          echo "BRANCH_TO_PROMOTE=${branch}" >> "$GITHUB_ENV"

      - id: get-output
        name: Configure environment output
        run: |
          set -euo pipefail

          echo "environment=${ENVIRONMENT}" >> "$GITHUB_OUTPUT"
          echo "environment_to_promote=${ENVIRONMENT_TO_PROMOTE}" >> "$GITHUB_OUTPUT"
          echo "branch_to_promote=${BRANCH_TO_PROMOTE}" >> "$GITHUB_OUTPUT"

      - id: get-commit-to-promote
        name: Get the commit to promote
        run: |
          set -euo pipefail

          echo "Promotion from branch: $ENVIRONMENT_TO_PROMOTE"
          echo "Promotion to branch: $ENVIRONMENT"
          echo "Current commit: ${{ github.sha }}"

          found_commit=""
          while read commit; do
            if git branch --remote --contains "$commit" | grep -q "origin/$BRANCH_TO_PROMOTE$"; then
              echo "Selected commit $commit"
              echo "commit_sha=${commit}" >> "$GITHUB_OUTPUT"
              found_commit="$commit"
              break
            fi
            echo "Skipping commit $commit"
          done < <(git rev-list -n 300 HEAD)

          if [[ -z "$found_commit" ]]; then
            echo "Commit to promote not found" >&2
            exit 1
          fi

  promote-image:
    name: Promote shared-services image
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs: [configure-promotion]
    runs-on: bluestack
    steps:
      - uses: actions/checkout@v4

      - name: Install crane
        uses: elastio/actions/install@v1
        with:
          tool: crane

      - name: Configure AWS credentials
        uses: elastio/actions/aws-creds@v1
        with:
          role_to_assume: arn:aws:iam::648105227319:role/GitHub-OIDC-SharedServices-ECR-RW
          region: us-east-2
          role_duration_seconds: 3600

      - id: login-ecr
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.BS_RESOURCES_AWS_ACCOUNT_ID }}
          mask-password: "true"
          skip-logout: "true"

      - name: Configure environment
        uses: elastio/gh-actions/actions/configure-env@master

      - name: Configure registry environment
        run: |
          set -eu
          echo "REPOSITORY=${ENVIRONMENT}/blues/shared-services/service" >> "$GITHUB_ENV"
          echo "REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> "$GITHUB_ENV"

      - name: Configure promotion environment
        run: |
          set -euxo pipefail

          declare -A env_map=(
            ["refs/heads/staging"]="development master"
            ["refs/heads/production"]="staging staging"
          )

          git_ref="${{ github.ref }}"

          if [[ -v env_map[$git_ref] ]]; then
            IFS=' ' read -r environment branch <<< "${env_map[$git_ref]}"
          else
            printf "Error: Unexpected branch '%s'\n" "$git_ref"
            exit 1
          fi

          echo "ENVIRONMENT_TO_PROMOTE=${environment}" >> "$GITHUB_ENV"
          echo "BRANCH_TO_PROMOTE=${branch}" >> "$GITHUB_ENV"

      - name: Promote image
        run: |
          set -eu

          IMAGE_TAG_TO_PROMOTE="${{ needs.configure-promotion.outputs.commit_to_promote }}"
          IMAGE_TAG="${{ github.sha }}"

          echo "Moving image from $ENVIRONMENT_TO_PROMOTE to $ENVIRONMENT"
          echo "Source tag: $IMAGE_TAG_TO_PROMOTE"
          echo "Destination tag: $IMAGE_TAG"

          IMAGE_PATH=$REGISTRY/$REPOSITORY

          IMAGE_URL=$IMAGE_PATH:$IMAGE_TAG
          IMAGE_URL_TO_PROMOTE=${IMAGE_PATH/$ENVIRONMENT/$ENVIRONMENT_TO_PROMOTE}:$IMAGE_TAG_TO_PROMOTE

          crane cp "${IMAGE_URL_TO_PROMOTE}" "${IMAGE_URL}"

  deploy-to-k8s:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/production'
    needs: [promote-image]
    uses: elastio/gh-actions/.github/workflows/deploy-to-k8s.yml@master
    with:
      service-name: shared-services
    secrets:
      CLOUDSMITH_HELM_REPO_USERNAME: ${{ secrets.CLOUDSMITH_HELM_REPO_USERNAME }}
      CLOUDSMITH_HELM_REPO_PASSWORD: ${{ secrets.CLOUDSMITH_HELM_REPO_PASSWORD }}
      CI_BLUE_STACK_STAGING_AWS_ROLE_ARN: ${{ secrets.CI_BLUE_STACK_STAGING_AWS_ROLE_ARN }}
      CI_BLUE_STACK_PRODUCTION_AWS_ROLE_ARN: ${{ secrets.CI_BLUE_STACK_PRODUCTION_AWS_ROLE_ARN }}
